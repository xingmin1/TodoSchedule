# 操作记录

## 2024-03-21 实现浮动按钮多功能

### 功能描述
实现了课程表界面的浮动按钮多功能支持,包括:
1. 快速添加功能
2. 添加课程功能
3. 添加普通日程功能

### 具体改动
1. 创建了 `QuickAddScheduleSheetContent.kt` 组件,实现底部弹出的快速添加界面
2. 创建了 `QuickAddScheduleViewModel.kt`,处理快速添加的业务逻辑
3. 更新了 `ScheduleScreen.kt` 中的浮动按钮实现,添加了 BottomSheet 支持

### 实现细节
1. 使用 Material3 的 ModalBottomSheet 实现底部弹出
2. 提供快速添加输入框和发送按钮
3. 提供详细添加选项卡片,支持跳转到具体的添加页面
4. 添加了错误处理和加载状态显示

### 待优化项
1. 快速添加文本的智能解析功能待实现
2. 详细添加页面的数据预填充功能待完善
3. 可以考虑添加更多快捷操作选项

## 2024-03-21 修复快速添加功能

### 修复内容
1. 修复了 `QuickAddScheduleViewModel.kt` 中的状态定义和业务逻辑:
   - 完善了 UI 状态数据类
   - 修复了错误处理机制
   - 优化了保存流程
   - 添加了详细的中文注释

2. 修复了 `QuickAddScheduleSheetContent.kt` 中的问题:
   - 修复了与 ViewModel 状态的绑定
   - 优化了输入框的实现
   - 完善了日期和时间选择功能
   - 改进了错误提示和加载状态显示

### 改进效果
1. 提升了代码可维护性
2. 优化了用户体验
3. 完善了错误处理
4. 提高了代码的健壮性

## 2024-03-21 重新设计快速添加界面

### 设计改进
1. 将底部弹出框改为对话框样式：
   - 创建了 `QuickAddScheduleDialog` 组件
   - 添加了日期和时间选择器组件
   - 优化了类型选择器的布局
   - 根据不同类型显示不同的输入字段

2. 新增功能：
   - 使用 FilterChip 实现类型选择
   - 添加了课程特有字段（教师、学分、周次范围）
   - 优化了日期和时间选择的交互
   - 添加了错误提示和验证

3. 界面优化：
   - 使用 Material3 的对话框设计
   - 优化了输入框的布局和样式
   - 改进了按钮的位置和样式
   - 添加了滚动支持

### 后续计划
1. 添加颜色选择功能
2. 实现重复规则设置
3. 优化提醒设置
4. 添加模板功能

## 2024-03-21 修复应用闪退问题

### 问题描述
点击浮动按钮后应用闪退,原因是 FocusRequester 没有正确初始化和使用。

### 修复内容
1. 移除了不必要的焦点管理代码:
   - 删除了 FocusRequester 相关代码
   - 简化了输入框的实现
   - 优化了状态管理

2. 完善了日期和时间选择功能:
   - 修复了日期选择器的状态管理
   - 优化了时间选择的处理逻辑
   - 添加了时间槽的自动计算

3. 改进了错误处理:
   - 优化了错误消息的显示逻辑
   - 添加了更多错误提示
   - 完善了错误状态的重置

### 改进效果
1. 修复了应用闪退问题
2. 提升了界面稳定性
3. 优化了用户体验
4. 完善了数据处理逻辑

## 2024-03-21 修复时间计算问题

### 问题描述
在计算结束时间时使用了不存在的 `plusHours` 方法导致编译错误。

### 修复内容
1. 修改了时间计算逻辑:
   - 使用手动计算替代 `plusHours` 方法
   - 添加了小时溢出处理
   - 保持分钟数不变

2. 优化了代码结构:
   - 提取了时间计算逻辑
   - 添加了注释说明
   - 改进了可读性

### 改进效果
1. 修复了编译错误
2. 提高了代码健壮性
3. 保证了时间计算的准确性
4. 改进了代码可维护性

## 2024-03-21 优化快速添加界面

### 界面优化
1. 改进了布局结构:
   - 优化了按钮间距和对齐
   - 调整了工具栏布局,分为左右两组
   - 美化了按钮样式和交互效果

2. 完善了输入区域:
   - 添加了圆角效果
   - 优化了输入框边框颜色
   - 改进了文本样式

3. 优化了日期时间选择:
   - 添加了实时日期显示
   - 优化了时间选择的显示格式
   - 改进了按钮样式和交互

### 交互改进
1. 优化了按钮反馈:
   - 添加了合适的点击区域
   - 统一了图标颜色
   - 改进了按钮状态切换效果

2. 改进了工具栏布局:
   - 优化了按钮分组
   - 调整了间距和对齐
   - 改进了 GIF 按钮样式

### 后续优化
1. 添加过渡动画
2. 实现工具按钮功能
3. 优化键盘弹出效果
4. 添加手势操作支持

## 2024-03-21 修复快速添加日程功能

1. 创建 `AddCourseUseCase` 类
   - 在 `domain/use_case/course` 目录下创建 `AddCourseUseCase.kt`
   - 实现添加课程的用例逻辑

2. 重构 `QuickAddScheduleViewModel`
   - 添加课程和普通日程的支持
   - 完善 UI 状态管理
   - 添加必要的验证逻辑
   - 优化错误处理

3. 主要改进：
   - 支持课程和普通日程的快速添加
   - 添加周次范围、教师、学分等课程特有字段
   - 完善时间选择和日期选择功能
   - 优化用户反馈和错误提示

## 2024-03-21 修复 QuickAddScheduleSheetContent 的编译错误

### 修复内容
1. 修复了状态管理相关的错误：
   - 将 `mutableStateOf(0)` 改为 `mutableIntStateOf(0)`，以正确处理整数状态
   - 优化了导入语句，使用通配符导入减少代码量

2. 修复了组件相关的错误：
   - 将 `Button` 改为 `FilledTonalButton`，使用 Material3 的新组件
   - 确保所有组件都在 Composable 上下文中使用

3. 优化了代码结构：
   - 整理了导入语句，减少冗余
   - 保持了代码风格的一致性

### 改进效果
1. 修复了所有编译错误
2. 提高了代码可读性
3. 改进了组件的使用
4. 优化了状态管理

### 后续优化
1. 可以考虑添加动画效果
2. 可以优化组件的性能
3. 可以添加更多的主题支持
4. 可以改进组件的可访问性

## 2024-03-21 修复快速添加日程的编译错误

### 修复内容
1. 修复了 `QuickAddScheduleViewModel.kt` 中的编译错误：
   - 添加了 `GlobalSettingRepository` 依赖，用于获取默认课表ID
   - 修改了获取默认课表ID的逻辑，先获取用户ID，再获取默认课表ID
   - 添加了错误处理，当用户未登录或未设置默认课表时抛出异常
   - 修正了 `ScheduleType` 的映射，将 `ONLINE_CLASS` 映射到 `ONLINE_COURSE`

### 改进效果
1. 修复了所有编译错误
2. 提高了代码的健壮性
3. 完善了错误处理机制
4. 优化了用户体验

## 2024-06-09

feat(QuickAddSchedule): 增加高级功能支持

- 新增颜色选择区块，支持主题色和自定义色选择，提升个性化体验。
- 新增提醒时间自定义区块，支持多种提前分钟数，用户可灵活设置提醒。
- 新增重复规则自定义区块，支持常见重复类型，满足多样化日程需求。
- 相关 UI 状态、ViewModel 方法与页面逻辑均已完善，所有新功能均有简明中文注释。

本次升级显著增强了快速添加对话框的功能性和可扩展性。

style(QuickAddScheduleDialog): 优化对话框悬浮位置

- 在 Dialog 外层增加 Box，设置较大的 bottom padding（如 120dp），使对话框整体悬浮于屏幕中间偏上，底部空间更大。
- 提升了视觉美观性和交互体验，避免对话框贴近底部。

fix(QuickAddSchedule): 修复课程添加逻辑为节次模式

- 课程类型下不再显示时间选择，而是显示"开始节次"和"节数"输入框。
- ViewModel 状态增加 startNode/step 字段，保存课程时 CourseNode 用节次信息。
- 其他类型仍用时间选择。
- 优化了交互体验，符合课程实际场景。

feat(QuickAddScheduleDialog): 整体美化对话框UI

- 类型选择区横向一排，支持横向滚动，选中高亮。
- 分组标题加粗，分割线 Divider 分隔分组。
- 输入框间距统一，label 字体更大，错误提示更明显。
- 课程节次输入用下拉选择（DropdownMenu），避免手输。
- 颜色选择区圆形色块更大，选中有明显边框。
- 底部按钮区悬浮、圆角、阴影，主按钮高亮。
- 适当增加圆角、阴影、padding，整体更现代美观。
- 保持所有中文注释，提升可维护性。

fix(ui): 修正 QuickAddScheduleDialog.kt 中 BorderStroke 的导入路径，将 material3 包改为 foundation 包，解决编译报错。

feat(QuickAddScheduleDialog): 课程节次/节数输入改为 ExposedDropdownMenuBox 下拉选择，颜色选择区弹窗内实现可选自定义色块。
- 下拉选择体验更好，交互直观。
- 自定义色弹窗内可选多种色块，选中后可用。
- 所有新代码均有中文注释。

fix(QuickAddScheduleDialog): 自定义色块选中时类型由 ColorSchemeEnum.Custom 改为 ColorSchemeEnum.Fixed，解决编译报错。

feat(QuickAddScheduleDialog): 优化了快速添加弹窗中的颜色选择器，将原有横向排列的色块改为调色盘网格布局，解决了按钮重叠问题。
- 新增自定义调色盘弹窗，支持通过色相-明度二维选择任意颜色，提升了颜色选择的丰富性和交互体验。
- 所有相关代码均添加了简明中文注释，便于理解和维护。

feat(QuickAddScheduleDialog): 优化了快速添加弹窗中的提醒设置区块：
- 支持更多提醒方式（如：准时、提前5/10/30分钟、1/2小时、1天、前一天晚上8点、整点提醒等）。
- 新增"自定义"选项，弹窗输入任意分钟数，满足个性化需求。
- 提醒方式采用 FlowRow 美化布局，交互更直观，视觉更美观。
- 所有相关代码均添加了简明中文注释。

- 优化普通日程类型：
  - 增加"详情"输入框，支持填写详细内容。
  - 移除默认1小时时间跨度，允许用户自由选择开始和结束时间，时间点即为时间点。
  - ViewModel 状态和保存逻辑已同步支持详情字段。
  - 所有相关代码均添加了简明中文注释。

- 修复普通日程颜色在课表页面不显示的问题：
  - 修正了OrdinarySchedule的color字段在数据库存储时的序列化（toString）和读取时的反序列化（toColorSchemeEnum）逻辑。
  - 现在ColorSchemeEnum类型的颜色能正确保存到数据库，并在课表页面正常显示。

- 修复 OrdinaryScheduleDetailScreen.kt 页面完成进度未实时刷新的问题：
  1. 在 OrdinaryScheduleDetailViewModel.kt 中新增 toggleTimeSlotCompleted 方法，支持切换时间段完成状态并调用 UseCase 持久化。
  2. 在 OrdinaryScheduleDetailScreen.kt 中，将时间段完成状态的点击事件与 ViewModel 方法连接，确保进度条和 UI 实时刷新。
  3. 修正 OrdinaryScheduleDetailScreen.kt 中 ViewModel 获取和 Composable 调用方式，删除无用导入，直接将 viewModel::toggleTimeSlotCompleted 作为回调传递，解决编译和作用域错误。 

## 2024-06-09 新增课表视图模式切换相关代码

1. 新增 `app/src/main/java/com/example/todoschedule/ui/schedule/ScheduleViewMode.kt`，定义了 `ScheduleViewMode` 枚举，包含 WEEK（周视图）、MONTH（月视图）、DAY（日视图）三种模式。
2. 在 `ScheduleViewModel.kt` 中添加了 `viewMode` 状态（`MutableStateFlow<ScheduleViewMode>`），并提供了 `setViewMode(mode: ScheduleViewMode)` 方法用于切换视图模式。

3. 在 `ScheduleScreen.kt` 中：
   - 监听 viewModel.viewMode 状态。
   - 在"更多"按钮点击后弹出 DropdownMenu，允许用户选择"周视图"、"月视图"、"日视图"。
   - 根据当前模式，渲染不同内容：周视图用原有内容，月/日视图用占位 Composable（显示"开发中..."）。

4. 重构了 app/src/main/java/com/example/todoschedule/ui/schedule/ScheduleScreen.kt 文件中的 MonthScheduleContent 组件：
  - 移除了原有的头部（Header）和多模式月历，仅保留标准月日历视图。
  - 实现了固定的星期标签行（"日 一 二 三 四 五 六"），与日期格子对齐。
  - 日期格子区域采用 7 列 6 行（共 42 格），支持上月/下月补齐。
  - 本月日期正常显示，非本月日期灰显，今天高亮，选中日期高亮。
  - 有事件的小圆点标记，点击格子可选中。
  - 下方展示选中日期的日程列表。
  - 代码中添加了简明中文注释，便于理解和维护。
  - 保持了 paddingValues 的处理，兼容外部布局。 

## 2024-06-10 优化月日历显示与交互

- 新增两种显示模式：默认小格子模式和下滑大格子模式。
- 支持上下滑动手势切换模式。
- 大格子模式下，日历格子高度增大，日期下方显示日程标签，最多2个，超过显示+N。
- 小格子模式下仅显示事件小圆点。
- 页面整体支持上下滑动。
- 代码中添加了简明中文注释。
- 保持了 paddingValues 处理。 

- 优化月日历页面：大格子模式下不再展示下方选中日期的日程列表，仅小格子模式下展示，提升UI一致性和用户体验。 

- 修复月日历模式切换的滑动手势失灵问题。
- 将手势监听逻辑单独包裹在日历网格外层的 Box 上，避免与 verticalScroll 冲突。
- 使用 awaitPointerEventScope 精确判断滑动距离，滑动超过 100dp 时切换模式。
- 其它 UI 结构和逻辑保持不变。 

## 2024-06-10 修复记录（补充）

- 修复月视图普通日程不显示问题：
  - 在 `ScheduleViewModel.kt` 的 `getDisplayableTimeSlotsForMonth` 方法中，像周视图一样为 ordinarySchedules 的每个 TimeSlot 设置 `displayTitle`、`displaySubtitle`、`displayColor` 字段，保证 UI 能正确显示普通日程信息。

## 2024-06-10 修复记录

- 修正 `ScheduleViewModel.kt` 中 `getDisplayableTimeSlotsForMonth` 方法：
  - 正确使用 `first()` 收集 `Flow<List<Course>>`，避免直接对 Flow 做集合操作导致的未解析引用和类型错误。
  - 检查并确保 `Course`、`CourseNode` 字段引用（如 nodes、startWeek、endWeek、day、startNode、step、room、color、courseName 等）全部与数据模型一致。
  - 所有集合操作（如 flatMap、filter、any 等）均基于 List 类型，消除类型歧义。
  - 逻辑保持与原有一致，保证月视图日程数据正确获取与展示。 

- 修复 `app/src/main/java/com/example/todoschedule/ui/schedule/ScheduleScreen.kt` 文件中 `MonthScheduleContent` 里的 `when` 语句导致的 Kotlin 语法错误，将其拆分为 if/else 结构，保证每个分支下只出现单一的 Composable 语句，避免编译报错。 

- 将月视图 AnimatedContent+手势切换逻辑重构为 Pager 方案：
  - 新增 MonthSchedulePager 组件，使用 HorizontalPager 实现左右滑动切换月份，动画流畅。
  - 新增 MonthSchedulePage 组件，负责单月渲染，内部保留上下滑切换大/小格子模式。
  - ScheduleScreen 中 ScheduleViewMode.MONTH 分支调用 MonthSchedulePager。
  - 所有日历网格、事件分组、点击跳转等逻辑全部复用，代码结构更清晰，滑动体验大幅提升。 

- 修正 MonthSchedulePager 组件中 Pager 的初始化方式：
  - 将 pageCount 作为 rememberPagerState 的参数传递，而不是 HorizontalPager 的参数，解决编译错误。 

- 将 isLargeMode（大/小格子模式）状态提升到 MonthSchedulePager 层级，MonthSchedulePage 通过参数接收 isLargeMode 和 onLargeModeChange，保证滑动切换月份时格子模式一致且动画流畅。 

- 修复月视图中日程标签和日程安排列表的排序问题，保证所有日程均按时间先后顺序显示，提升用户体验。 

- 优化月视图大/小格子模式切换时日程安排的出现/消失动画，采用 AnimatedVisibility + slideInVertically/slideOutVertically，让动画更平滑自然，提升用户体验。 